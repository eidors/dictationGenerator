<!DOCTYPE html>
<html>

<head>
    <title>Bootstrap 实例</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/popper.js/1.15.0/umd/popper.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="js/FileSaver.js"></script>
    <script src="js/七上.js"></script>
    <script type="text/javascript" src="./js/html2canvas.js"></script>
    <script type="text/javascript" src="./js/jsPdf.debug.js"></script>
</head>

<body>

    <div class="container contentFrom">
        <h2>添加诗词</h2>
        <div class="form-group">
            <label for="title">标题:</label>
            <input type="text" class="form-control" id="title" placeholder="标题">
        </div>
        <div class="form-group">
            <label for="author">作者:</label>
            <input type="text" class="form-control" id="author" placeholder="作者">
        </div>
        <div class="form-group">
            <label for="years">年代:</label>
            <input type="text" class="form-control" id="years" placeholder="年代">
        </div>
        <div class="form-group">
            <label for="content">内容:</label>
            <textarea type="text" class="form-control" id="content" placeholder="内容" rows="5"></textarea>
        </div>
        <div class="form-group">
            <button type="button" class="btn btn-primary addContent">添加</button>
            <button type="button" class="btn btn-primary createProblem">生成</button>
            <button type="button" class="btn btn-primary removeContent float-right">清空</button>
        </div>
        <div class="contentBody">
            <!-- <div class="post_right">
                <h2 class="post_title1">游子吟</h2>
                <div class="post_property">
                    <div class="post_author">
                        <a href="https://www.cik2.com/zuozhe/tangdai/" target="_blank" title="唐代">唐代</a>
                    </div>
                    <div class="post_author">
                        <a href="https://www.cik2.com/zuozhe/9632c2914.html" target="_blank" title="孟郊">孟郊</a>
                    </div>
                </div>
                <div class="post_brief r_main show" id="ddidi-1">慈母手中线，游子身上衣。<br>临行密密缝，意恐迟迟归。<br>谁言寸草心，报得三春晖。</div>
            </div> -->
        </div>
    </div>
    <div class="container">
        <div class="renderPdf" id="renderPdf" style="background-color: white; color: black; padding: 0 100px;">
            <div class="problemBody"></div>
        </div>
    </div>
    <script>
        //
        var textHtml = [];
        textHtml.push('<div class="post_right">');
        textHtml.push('<h2 class="post_title1">{title}</h2>');
        textHtml.push('<div class="post_property">');
        textHtml.push('<div class="post_author">{years} {author}</div>');
        textHtml.push('</div>');
        textHtml.push('<div class="post_brief r_main show" id="ddidi-1">{content}</div>');
        textHtml.push('</div>');
        $(".addContent").click(function() {
            addContent();
        });
        $(".removeContent").click(function() {
            $(".contentBody").html("");
            arrLines = [];
        });
        $(".createProblem").click(function() {
            createProblem();
            $(".contentFrom").hide();
            createPdfFiles();
            $(".contentFrom").show();
        });
        var arrLines = [];
        var arrCenterChart = ["，", "。", "；", "？", "！"];

        function addContent() {
            var title = $("#title").val();
            var author = $("#author").val();
            var years = $("#years").val();
            var content = $("#content").val();
            // content.split("\n");
            var bolIsExist = false;
            $.each(content.split("\n"), function(index, value) {
                var objJson = {};
                objJson.title = title;
                objJson.author = author;
                objJson.years = years;
                var arrContents = [];
                var strLastChart = value.charAt(value.length - 1);
                if (arrCenterChart.indexOf(strLastChart) > -1) {
                    var strValueLostLastChart = value.substr(0, value.length - 1);
                    $.each(arrCenterChart, function(index1, strChart) {
                        if (strValueLostLastChart.indexOf(strChart) > -1) {
                            strValueLostLastChart = strValueLostLastChart.replaceAll(strChart, strChart + "|||" + strChart);
                        }
                    });
                    value = strValueLostLastChart + strLastChart;
                } else {
                    $.each(arrCenterChart, function(index1, strChart) {
                        if (value.indexOf(strChart) > -1) {
                            value = value.replaceAll(strChart, strChart + "|||" + strChart);
                        }
                    });
                }
                // $.each(arrCenterChart, function(index1, strChart) {
                //     if (obj.content == value) {
                //         bolIsExist = true;
                //     }
                // });
                objJson.content = value.split("|||");
                $.each(arrLines, function(index1, obj) {
                    if (obj.content == value) {
                        bolIsExist = true;
                    }
                });
                if (!bolIsExist) {
                    arrLines.push(objJson);
                }
            });
            if (!bolIsExist) {
                var $contentBody = $(".contentBody");
                $contentBody.append(textHtml.join("").replace("{title}", title).replace("{author}", author).replace("{years}", years)
                    .replace("{content}", content.replaceAll("\n", '<br>')));
            }
        }

        function createProblem() {
            var badChar = "，。？！";
            $(".problemBody p").remove();
            var arr = [];
            var arr = JSON.parse(JSON.stringify(arrLines));
            arr = roa(arr);
            // downloadTextFile(JSON.stringify(arr));
            for (var i = 0; i < 20; i++) {
                var arrContent = arr[i]["content"];
                // debugger;
                var arrAnswerNums = createAnswerNumArr(arrContent);
                var arrAnswers = [];
                $.each(arrAnswerNums, function(index, value) {
                    arrAnswers.push(arrContent[value].replace("，", "").replace("？", "").replace("？", "").replace("。", ""));
                    if (badChar.indexOf(arrContent[value].charAt(arrContent[value].length - 1)) > -1) {
                        arrContent[value] = "_____________________" + arrContent[value].charAt(arrContent[value].length - 1);
                    } else {
                        arrContent[value] = "_____________________。";
                    }
                });
                var strContent = arrContent.toString().replaceAll(",", "").replaceAll("，，", "，").replaceAll("。。", "。").replaceAll("？？", "？").replaceAll("！！", "！") +
                    " （《" + arr[i]["title"] + "》 " + arr[i]["author"] + "）";
                $(".problemBody").append($("<p>").text(strContent));
                $(".problemBody").append($("<p style='color:red'>").text(arrAnswers.toString().replaceAll(",", " ")));
            }
        }

        function createPdfFiles(){
            html2canvas($(".renderPdf")[0], {
                onrendered:function(canvas) {

                    //返回图片URL，参数：图片格式和清晰度(0-1)
                    var pageData = canvas.toDataURL('image/jpeg', 1.0);

                    //方向默认竖直，尺寸ponits，格式a4【595.28,841.89]
                    var pdf = new jsPDF('', 'pt', 'a4');

                    //需要dataUrl格式
                    pdf.addImage(pageData, 'JPEG', 0, 0, 595.28, 592.28/canvas.width * canvas.height );

                    pdf.save('content.pdf');

                }
            });
        }
        function roa(arr) //arr为可能出现的元素集合
        {
            var temp = []; //temp存放生成的随机数组
            　
            var count = arr.length;
            for (i = 0; i < count; i++) {
                var num = Math.floor(Math.random() * arr.length); //生成随机数num
                temp.push(arr[num]); //获取arr[num]并放入temp
                arr.splice(num, 1);
            }
            return temp;
        }

        function createMain() //arr为可能出现的元素集合
        {
            var badChar = "，。？！";
            $(".container p").remove();
            var arr = [];
            var cloneGushiObj = JSON.parse(JSON.stringify(gushiObj));
            $.each(cloneGushiObj, function(title, value) {
                $.each(value["content"], function(index1, value1) {
                    var obj = {};
                    obj.title = title;
                    obj.name = value["name"];
                    obj.time = value["time"];
                    obj.content = value1;
                    arr.push(obj);
                });
            });
            arr = roa(arr);
            // downloadTextFile(JSON.stringify(arr));
            for (var i = 0; i < 20; i++) {
                var arrContent = arr[i]["content"];
                // debugger;
                var arrAnswerNums = createAnswerNumArr(arrContent);
                var arrAnswers = [];
                $.each(arrAnswerNums, function(index, value) {
                    arrAnswers.push(arrContent[value].replace("，", "").replace("？", "").replace("？", "").replace("。", ""));
                    if (badChar.indexOf(arrContent[value].charAt(arrContent[value].length - 1)) > -1) {
                        arrContent[value] = "_____________________" + arrContent[value].charAt(arrContent[value].length - 1);
                    } else {
                        arrContent[value] = "_____________________。";
                    }
                });
                var strContent = arrContent.toString().replaceAll(",", "").replaceAll("，，", "，").replaceAll("。。", "。").replaceAll("？？", "？").replaceAll("！！", "！") +
                    " （《" + arr[i]["title"] + "》 " + arr[i]["name"] + "）";
                $(".container").append($("<p>").text(strContent));
                $(".container").append($("<p style='color:red'>").text(arrAnswers.toString().replaceAll(",", " ")));
            }
        }

        function createAnswerNumArr(arr) {
            var cloneArr = JSON.parse(JSON.stringify(arr));
            var temp = []; //temp存放生成的随机数组
            var answerNum = Math.floor(cloneArr.length / 2);
            for (i = 0; i < answerNum; i++) {
                var num = Math.floor(Math.random() * cloneArr.length); //生成随机数num
                temp.push(arr.indexOf(cloneArr[num])); //获取arr[num]并放入temp
                cloneArr.splice(num, 1);
            }
            return arrSort(temp);
        }

        function arrSort(arr) {
            var asc = function(a, b) {
                return a - b;
            }
            var desc = function(a, b) {
                return b - a;
            }
            return arr.sort(asc);
        }

        function downloadTextFile(mobileCode, fileName) {
            fileName = fileName || "test.json";
            //mobileCode 为写入文件的内容，可以通过获取文本框的value写入
            var file = new File([mobileCode], fileName, {
                type: "text/plain;charset=utf-8"
            });
            saveAs(file);
        }

        
        var downPdf = document.getElementById("renderPdf");

        downPdf.onclick = function() {
            html2canvas($(".renderPdf")[0], {
                onrendered:function(canvas) {

                    //返回图片URL，参数：图片格式和清晰度(0-1)
                    var pageData = canvas.toDataURL('image/jpeg', 1.0);

                    //方向默认竖直，尺寸ponits，格式a4【595.28,841.89]
                    var pdf = new jsPDF('', 'pt', 'a4');

                    //需要dataUrl格式
                    pdf.addImage(pageData, 'JPEG', 0, 0, 595.28, 592.28/canvas.width * canvas.height );

                    pdf.save('content.pdf');

                }
            })
        }
    </script>
</body>

</html>